{"status":{},"contains_secrets":true,"product_version":"3.4.0","spec":{"description":"","resources":{"client_attrs":{"None":{"y":160.25,"x":189.5390625},"decb8265_deployment":{"y":-627.5,"x":276}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3b8701f6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"244932b5_runbook","main_task_local_reference":{"kind":"app_task","name":"3b8701f6_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3fddfa76_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"3b982661_runbook","main_task_local_reference":{"kind":"app_task","name":"3fddfa76_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"267fcd78_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"292034ce_runbook","main_task_local_reference":{"kind":"app_task","name":"267fcd78_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"5c64d685_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"4fcf4ddc_runbook","main_task_local_reference":{"kind":"app_task","name":"5c64d685_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"cb5d5768_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"06ce90e3_runbook","main_task_local_reference":{"kind":"app_task","name":"cb5d5768_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Provisioning VM","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"blueprint_uuid","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"variable_list","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"launch_uuid","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"KUBEADMIN","value":"lwoNpNc5LbDn2iFznrbw4np7JUjovc+UkHg4eFPf+Fc=:utf-8","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"KUBECONFIG","value":"m8M+aBsDDrwTUDDWhaFtt10mF9Akr7PvbFrosN6OK1U=:utf-8","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""}],"substrate_definition_list":[{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"Provisioning_VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"b1291dd8_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ef7e6850_runbook","main_task_local_reference":{"kind":"app_task","name":"b1291dd8_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"Provisioning_VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"10682da3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"083c406a_runbook","main_task_local_reference":{"kind":"app_task","name":"10682da3_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"Provisioning_VM","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"20","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"os_type":"Linux","create_spec":{"name":"Openshift-provisioning-@@{calm_array_index}@@-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","vpc_reference":null,"ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"1770296b-4f46-42cc-b8b0-bc7b74d8d713"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":2,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nusers:\n  - name: @@{CRED.username}@@\n    ssh-authorized-keys:\n      - @@{CRED.public_key}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nwrite_files:\n  - path: \/etc\/NetworkManager\/conf.d\/90-dns-none.conf\n    content: |\n      [main]\n      dns=none"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"560e3984-79df-4737-be4e-6fc11e1f55ac","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"LEGACY","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"Centos84","uuid":"69863a1c-9389-473e-b33d-559b8baeb70c"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":{"kind":"cluster","type":"","name":"SGNTNXMGMTPE_AZ03","uuid":"0005d284-fb66-e50b-0000-00000001c48e"},"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"core","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":true,"secret_reference":{}},"value":"+tQX5vV9zr4XZqU51+O+UOQz+neMDIjZC1Dvakxedx+8jPXKhTmWvJc26Ju1fC3DpgnsoPzv7UVVBgeImxfRobVlcjQR07p9dCnchc3h2d\/qXayzuX3WrTWRqF9ksEM0Jl2VJPyeXvrxkENpdAXWZehkl+\/1fVsozNwJoTR\/CwozWVPeF5QLeW3eQDTW8U8+3Xbp\/Chi6q3qAiBF6Mnc4r\/oJ4DoaWL6q8\/qkHdn+ZRPJQzza9rgT97iA4dHOEKaSBgXUQ9GiMytThixZZq6JMPalu7dpYsV\/AGSE6YyHuYL7GUvXdCtg6yyqjmkJV4glOL10dA5JooyramSxICQxcBOU5\/3FM1u9e1L2XXwTaYe+TuL1we2fg3jWunnH+Nxdwk1Mf3PSrs40Q\/DO4YbeqJz3iJzPlub6s8v2Mzq4Mcrtk2QgVByAhoJ1gjVnUqe56Fmnu1cNd6tyvjHV3nrtgCnIWDOfDrO9x6S2Jv3yEBw8lCR6I1MG4msdhpY2HouHFlj81UuAJ0vHtSJelNvIpnrjvjKHB1OsC3mP85K874XYTWU+4aWf551etbILBGm+kGGMTI6GCtagZmy8KNRWGQPCEocRwrsUAYjyXbDGD2MxT4HXJnEquYT0KoC+OTSIp4P6NG\/mJUvAROgB34oB4IzTbELNEdhNWMOgeSfBBEALJ4GmNjiSHjD\/w5PARtDqzC7jbcWwxhzKsl+1YxxBYyzSJNlzOHrsIetNMxozW4FsI4mPhn\/YMQL7uLRh3xXRIeBscdZ7BMAKUTRQ2j+V30AxIJfN1upNeuI0HyHxNt3yPK19K8XKXgwHxJ4aKutia\/0sgIqpwCsHHsiYkf4rXIprzmFaKo6zGJch2rzQ23a3Sy83vE+NLfwhXHDv2hKgj4Qzk3RjR7cQXqKsGjxgoKIv9JdLqm9bn\/h9RIiXTI2jAiHA4FbUJ8BSzHR7h1zOCB3fLpN+U3sZnKq\/5M0SuMRr3Pbn1LNqLrhVNYek5cCFCqoUa0mefkULHhTFrp1W5JVPhEVIREtHRvgqyg\/MbJAHYissP6Vo\/TwMX3ae2qJtBN5E1wKw4VTTBhHquRaavtsKikLP3QtaF9PI8joN56K5d2jC+tFSNNP7R44WU0lanYDnqAXz1NE+7vni+gnSLmnE4bQVvGpB0PzO6vC5\/5Fxby3tePF4MVtpGgFvnxZUOv\/vsxq8dKi4zGLvFmcJsoHCEPPgJp9rvVNroSQBlS\/h+D7Heblyttx2DKlVwfGXOIM++WkT8XLT0HHI\/NCjq2m5fLdGiG47s2RLBcObpx1K2plyojUVpnxaVN7MGoi217cFS5e\/cPbCuA9PxLNjvEEhwLtWe9wFVzdjpuImIrIdBjxPczlO2tfY\/h8XGDwQ0GFNj+d8v2k00kiE+Es8xgLAj7L\/Tmn8U3SJsy7j5gnkz6rbzyRCQxbrFaW\/PYdtLm+CPz\/KFx72q779chT92g7Fgq25Lc0uAxciQLCkvTADR\/2t1eDeKPednDpKqSBTqeB8m6O9vDRiiczv44BbR4+te7lH\/Nkdm8q29bm7N2W0Qt9GuxRgy\/X9xWW1JUk5dTwxj7\/8u3m3ZxJttrx\/veZR+M9+GYoGC9iaJFzKNuJIaECKRts2AqJ2VNitmLiL0ZPXOk5WQzK83UFxPrfoNjsBL1jcmgkuYEj29B4s9cHQEcLl0qwZkW392p\/QbxICELrW1B269trWFGQQqzdWI8LTION8DfGCFGxErZqxj54QSzh9qObDw35FOcg7kLVibpbQlGT1jzPlU+3hilptFGko\/VGl7T9hbl3kn5CwC4YQEdaPnYWs5mSWF9TYkRxTWuonnXoCRXy07HDl9s\/u7L7kDc4EvRxW1HF6+odRbGLEqVdt0nc0egIc0b84C57FToUrLxd3jkSuyKonQLszhhE9k0zJ2gi+UeIlDsrNUC4Spn5OKV2SjXCW\/dO7hcCGDp8znzCxQCjwwHe1ZMpjvSi1obGv+lEDLI9rgLv7W9YS\/LAATRH\/1lpoC5ntOxhNBdDYInp3\/SqfbBjOPaWumz1nbw4f5Vo02xVx9nGUC2WCpX4TvrKwvm0c\/Wa582BnIcwDrtalGgQ+UfW2qJisrEWjbUxXPPDWS5sL2ecbAqlv4lDsdFe61Lfo1hkygd3s4UhJ6KJTOxBsJa5NS5TquBQCbYxxF6vbZMC42AF\/0gfvBC9axdMLyjPtNZOS5pe0lxWnIEDITRXYiqIF4Z1SHd1LxrHQAPKt1gb4cZ1G324rs5DCa8Gedv8A5MI:utf-8"},"name":"CRED","cred_class":"static"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Provisioning VM"}],"name":"Setup","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Setup"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Setup"}],"name":"5707bf52_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Setup","attrs":{"exit_status":[],"script":"#!\/bin\/bash -e\n\n# Get machine IP\nMACHINE_IP=\"@@{address}@@\"\nSSH_USER=\"@@{CRED.username}@@\"\n\n# Inject ssh key pair into the VM for provisioning support\nmkdir -m 700 -p ~\/.ssh\ncat <<EOF >~\/.ssh\/id_rsa\n@@{CRED.secret}@@\nEOF\nchmod 600 ~\/.ssh\/id_rsa\ncat <<EOF > ~\/.ssh\/id_rsa.pub\n@@{CRED.public_key}@@\nEOF\n\nsudo rm -f \/etc\/yum.repos.d\/*.repo\necho '''[baseos]\nname=CentOS-$releasever - Base\nbaseurl=http:\/\/172.16.101.190\/repos\/centos\/$releasever\/$basearch\/os\/baseos\/\ngpgcheck=1\nenabled=1\ngpgkey=file:\/\/\/etc\/pki\/rpm-gpg\/RPM-GPG-KEY-centosofficial''' | sudo tee \/etc\/yum.repos.d\/CentOS-Base.repo\n\necho '''[appstream]\nname=CentOS-$releasever - appstream\nbaseurl=http:\/\/172.16.101.190\/repos\/centos\/$releasever\/$basearch\/os\/appstream\/\ngpgcheck=1\nenabled=1\ngpgkey=file:\/\/\/etc\/pki\/rpm-gpg\/RPM-GPG-KEY-centosofficial''' | sudo tee \/etc\/yum.repos.d\/CentOS-appstream.repo\n\necho '''[extras]\nname=CentOS-$releasever - Extras\nbaseurl=http:\/\/172.16.101.190\/repos\/centos\/$releasever\/$basearch\/os\/extras\/\ngpgcheck=1\nenabled=1\ngpgkey=file:\/\/\/etc\/pki\/rpm-gpg\/RPM-GPG-KEY-centosofficial''' | sudo tee \/etc\/yum.repos.d\/CentOS-Extras.repo\n\n\n\n# Update resolv.conf\n# Env setup\nmkdir -p openshift\ncd openshift\n\n# Install dependencies\nsudo yum -y install jq haproxy httpd python3\n\n# Disable selinux\nsudo setenforce 0\nsudo sed -i.bkp -r 's\/(SELINUX=)enforcing\/\\1disabled\/g;s\/^SELINUXTYPE=targeted\/#&\/g' \/etc\/selinux\/config\n\n# Download Openshift installer\ncurl -o openshift-install-linux.tar.gz \"@@{openshift_install_linux}@@\"\ntar xzf openshift-install-linux.tar.gz\nsudo install -m 755 -o root openshift-install \/sbin\/\n\n# Download coreos-installer\ncurl -o coreos-installer \"@@{coreos_installer}@@\"\nsudo install -m 755 -o root coreos-installer \/sbin\/\n\n# Download Openshift client\ncurl -o openshift-client-linux.tar.gz \"@@{openshift_client_linux}@@\"\ntar xzf openshift-client-linux.tar.gz\nsudo install -m 755 -o root oc \/sbin\/\n\n# Download RHCOS 4.7 iso\ncurl -o rhcos-live.x86_64.iso \"@@{rhcos_live}@@\"\n\n# Create Web Repo\nmkdir web\ncp coreos-installer ~\/openshift\/web\nmv openshift-client-linux.tar.gz ~\/openshift\/web\nmv openshift-install-linux.tar.gz ~\/openshift\/web\n\n# Change ownership of openshift dir to expose iso and igntion over an http endpoint\nsudo chown -R apache: ~\/openshift\/web\nsudo chmod 755 \"\/home\/${USER}\"\n\n# Configure and start apache on port 8080\nsudo sed -i.bkp 's\/Listen 80\/&80\/g' \/etc\/httpd\/conf\/httpd.conf\necho \"Alias \/openshift \/home\/${SSH_USER}\/openshift\/web\n<Directory \/home\/${SSH_USER}\/openshift\/web>\nOptions -Indexes\nRequire all granted\n<\/Directory>\" | sudo tee -a \/etc\/httpd\/conf.d\/openshift.conf\n# Enable and start apache\nsudo systemctl enable httpd\nsudo systemctl start httpd\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"20d21b90_runbook","main_task_local_reference":{"kind":"app_task","name":"5707bf52_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Setup"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a643dfca_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"24fb9eac_runbook","main_task_local_reference":{"kind":"app_task","name":"a643dfca_dag"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"Centos84","version":"","options":{"type":"","name":"Centos84","resources":{"image_type":"DISK_IMAGE","checksum":{"checksum_algorithm":"","type":"","checksum_value":""},"source_uri":"http:\/\/172.16.101.188\/images\/openshift\/CentOS-8-GenericCloud-8.4.2105-20210603.0.x86_64.qcow2","version":{"product_version":"1.0.0","type":"","product_name":"Centos84"},"architecture":"X86_64","type":""},"description":""},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"decb8265_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Setup"}],"substrate_local_reference":{"kind":"app_substrate","name":"Provisioning_VM"},"variable_list":[],"description":""}],"environment_reference_list":[],"patch_list":[],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Prepare Env"},{"kind":"app_task","name":"Auth"},{"kind":"app_task","name":"Fetch BP UUID"},{"kind":"app_task","name":"run Blueprint"},{"kind":"app_task","name":"Monitor BP"}],"name":"99ba075b_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Fetch BP UUID"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"run Blueprint"}},{"from_task_reference":{"kind":"app_task","name":"run Blueprint"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Monitor BP"}},{"from_task_reference":{"kind":"app_task","name":"Prepare Env"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Auth"}},{"from_task_reference":{"kind":"app_task","name":"Auth"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Fetch BP UUID"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Prepare Env","attrs":{"exit_status":[],"script":"#!\/bin\/bash -e\n\ncd ~\/openshift\n\n# Create ignition config used for generation of ignition files\ncat <<EOF > install-config.yaml\napiVersion: v1\nbaseDomain: @@{BASE_DOMAIN}@@\nmetadata:\n  name: @@{OCP_SUBDOMAIN}@@\ncompute:\n-  name: worker # add argument\n   replicas: @@{WORKER}@@\ncontrolPlane:\n  name: master # add argument\n  replicas: 3 # default\nnetworking:\n  clusterNetwork:\n  - cidr: @@{OCP_CLUSTER_NETWORK}@@                      \n    hostPrefix: @@{OCP_CLUSTER_HOSTPREFIX}@@\n  serviceNetwork:\n   - @@{OCP_SERVICE_NETWORK}@@\n  machineNetwork:\n  - cidr: @@{OCP_MACHINE_NETWORK}@@\nplatform:\n  none: {}\npullSecret: '@@{OCP_PULL_SECRET}@@'\nsshKey: \"@@{CRED.public_key}@@\"\nimageContentSources:\n- mirrors:\n  - ocp-mirror.infra.dsta.local:5000\/openshift\/4.9.8\n  source: quay.io\/openshift-release-dev\/ocp-release\n- mirrors:\n  - ocp-mirror.infra.dsta.local:5000\/openshift\/4.9.8\n  source: quay.io\/openshift-release-dev\/ocp-v4.0-art-dev\n\nEOF\n\n\n# Ignition file generation\n# This will generate bootstrap.ign,master.ign and worker.ign files\n# Ignition files are used for RCHCOS installation(similar to kickstart for RHEL)\nopenshift-install create ignition-configs\n\n# Get private IP address of primary interface\n# MACHINE_IP=$(ip -4 a show eth0  | awk '\/inet\/ {gsub(\/\\\/[0-9]+\/,\"\",$2);print $2}')\n\n# Embed MachineConfig for iscsid in ignition files\n\necho \"bootstrap.ign\nmaster.ign\nworker.ign\"| while read i; do\nj=${i%.*}\n#Check if self-deployed DNS must be patched into Iginition Files\n\njq '.storage.files +=[{\"overwrite\":true,\"path\":\"\/etc\/pki\/ca-trust\/source\/anchors\/repo.crt\",\"user\":{\"name\":\"root\"},\"contents\":{\"source\":\"data:text\/plain;charset=utf-8;base64,LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUdKekNDQkErZ0F3SUJBZ0lVQTFYV1lFeXlFaStWcmRaMFFiNFVRYnR5b2Q4d0RRWUpLb1pJaHZjTkFRRUwKQlFBd2dhSXhDekFKQmdOVkJBWVRBbE5ITVJJd0VBWURWUVFJREFsVGFXNW5ZWEJ2Y21VeEVEQU9CZ05WQkFjTQpCME5sYm5SeVlXd3hFREFPQmdOVkJBb01CMDUxZEdGdWFYZ3hEakFNQmdOVkJBc01CVk5oYkdWek1TUXdJZ1lEClZRUUREQnR2WTNBdGJXbHljbTl5TG1sdVpuSmhMbVJ6ZEdFdWJHOWpZV3d4SlRBakJna3Foa2lHOXcwQkNRRVcKRm5kcGJuTnZiaTV6YjNWQWJuVjBZVzVwZUM1amIyMHdIaGNOTWpFeE1qQTVNVE0wTWpVeldoY05Nakl4TWpBNQpNVE0wTWpVeldqQ0JvakVMTUFrR0ExVUVCaE1DVTBjeEVqQVFCZ05WQkFnTUNWTnBibWRoY0c5eVpURVFNQTRHCkExVUVCd3dIUTJWdWRISmhiREVRTUE0R0ExVUVDZ3dIVG5WMFlXNXBlREVPTUF3R0ExVUVDd3dGVTJGc1pYTXgKSkRBaUJnTlZCQU1NRzI5amNDMXRhWEp5YjNJdWFXNW1jbUV1WkhOMFlTNXNiMk5oYkRFbE1DTUdDU3FHU0liMwpEUUVKQVJZV2QybHVjMjl1TG5OdmRVQnVkWFJoYm1sNExtTnZiVENDQWlJd0RRWUpLb1pJaHZjTkFRRUJCUUFECmdnSVBBRENDQWdvQ2dnSUJBSlFpbEdnRm1rZHVDa1N2M0M3S2xlMTNEMGZaNXkydHphQzRUTE1PMkd2WVh4TGcKUzdnSDJ4LzlCaU95Y254cmVrSmh2Ymw3T1RRR0ZLb1hIYldLeWl4R0F1b25ka1BSM3ZJc3NaZlBxait3VDQrTQp3czhFN0JSeXNWYzBCcVNwNVREdVlkTzhkVFQwd3BNdXhWMG9Gc2NqN1FaeGp6UmxSNS9uaXJYUUJucWZOaThUClRIL0VKYTkzNUJ5SkM3TlVBN0trNHB0TVFFelFPUGNhSURGTmM1VDIvV3dYbEN1VnRQOVQyNUdaN3hIeS8rR2EKU3BTdWtSbS9qRGo5a3Y5VEliRDM4dmtZWjNCblYwbnZUYVJwR2JtZk5OM0FsNGVmNjFpZ0x0RTdTZUJBbzE3Mwp0VDF5bXBxY1J0a1I5SWxGOGo3L2F6U3RPSjBodk9ZL0JGYlVUUW5IMzB4NWZ1NlVJWWVraDI3MmVxY1djTjRBCjJsZkVyZnlURVJQM24rZU91Ui9OR3I4S3VDdlpVb3V0MXBkTG9KSVV1MC93QktkcVdDaklVLy9lWWtBYWRxY2EKL3FSVWhlTURtaEVIQXFqVHVyK1kvczVBeFRkZUpCOFhQdmhEZlp2MW05MVc3YWhIb05neS9LNG1OUTBDeEJLaApVQ3d3cHZJQ1l5SWlGUXRQSHBpWDBqcUlJTHl1NmtiMzJlYzUrdHhwZHlEV3dPNDV1enVrMmE2MW5EUUxFT3RJCnBVVGpCQ09Nem5jcWlWNmZTTHZoazNsbnFCUTBNVzhuelUrQVVhS3hxT3lhTW5wMTh3MzR5UzBrd2RZVEFSMFkKWGxPOFNPZ2NTK1JrUXJndUs5SzYrS2RMT211VlVVZVQxQWpYTUdSVnM2Y2dMWTB2THV4ck1DSTR5OFE5QWdNQgpBQUdqVXpCUk1CMEdBMVVkRGdRV0JCVFI5WHlHeDNNR3FYc3p4ckhzR1RjcXBlRVpJVEFmQmdOVkhTTUVHREFXCmdCVFI5WHlHeDNNR3FYc3p4ckhzR1RjcXBlRVpJVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElDQVFBTVRGV0RxZ0ZsL2lRRENzK29aUXp4K3pKZFBlOFBlbXVMNlVXYm9MTmtRWGhDUTh4TAo3NjJ3ZzNmNkNERll0aFMzdktCenJVUkdtTmY4c2swZmtaM3JXN3ZNNkhqL2R4T3hVczVJc1ZhQzY0MVdTWUhVCjZlZnlNV1NESndOVFdWYW1Qc3Z5UjFkZnEzMWVtTG1yUlhSUnY5WmxWNm8vUHFpNDFqbk1lUXhVRjJIT2FOajYKOEdibWN1ZSsvZmZBZ3FnUnBrbEw0Q0Qyd3lxRFVHSEJEdncveGxsOEpRLzhidlR1amVpY2FXMUcvaVdNQXBSTApGSVlYT1M5ZlBZVXR2NVZFblFITnRZMHBTcXJXdGJQT3NGY0xNWFJxdG5NVC96aThCcGdrUzM2TCtFeXJ3TVlQCnZxMytybWU0bDZiSzdBU2hZQlQ0a1lEYjhCTklzL05xWUtCMXB0YXp3aSt2MXo4aHlXN3NSUERnWStRRHJLdVUKaC8xOVlJb1RzWTFGNkFpbjcrVlVSdWkzUDVEWnpNN0NVK2p1VUp1eHltYTd0bkEzMnNOQ2haSE1aT242aU1EUwp5N0JSdWM5cTgvanM1ZnZIN3Zab1Blb3hUMEVNVFh4VkJWUDdJR1BvNnl4amk2R1ZWUnBaUGh2STJrdmJudFVhCitPdmJ1aDBEZGhDWkZxSWZaaXlCYU4rdjQ0dXdJdFBMT2pDL3FxUWdWM1U3M3MyTWFZVjkxUlZkOWRFelJ4Nm4KenVIL3h2UVNzcTc1bEY2c3lUa2xCYTNoZDM1aTN2bnVzWURMS2wzVTRBSk02VWY3cVBRb2pTR3hDRXJOWGhPQQpSVjFFbEhQMlNYdkIrV3VKNjNsOHMxNFZVUG5uSjBaNWtRK25nZ0s3RzBReWtqbXNmMTlUWXBXV3NnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=\"},\"mode\":644}]' ${i} > ${j}_@@{OCP_SUBDOMAIN}@@.ign\n\ndone\n\n# Copy RHCOS Image\n# Embed bootstrap ignition config in ISO for first boot\n# All VMs initially boot from ISO with embedded bootstrap ignition\n# coreos-installer is used to install OS on hdd for specific roles via ignition files after first boot\ncoreos-installer iso ignition embed -i bootstrap_@@{OCP_SUBDOMAIN}@@.ign rhcos-live.x86_64.iso -o rhcos-@@{OCP_SUBDOMAIN}@@.iso\n\nsudo mv rhcos-@@{OCP_SUBDOMAIN}@@.iso ~\/openshift\/web\nsudo mv *_@@{OCP_SUBDOMAIN}@@.ign ~\/openshift\/web\nsudo chown apache: ~\/openshift\/web\/*\n\nrm *.ign\nrm metadata.json","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Auth","attrs":{"exit_status":[],"script":"cd openshift\/auth\necho KUBECONFIG=\"$(base64 -w 0 kubeconfig)\"\necho KUBEADMIN=\"$(base64 -w 0 kubeadmin-password)\"\n\nrm kubeconfig\nrm kubeadmin-password\ncd ..\nrm -rf .openshift*","eval_variables":["KUBECONFIG","KUBEADMIN"],"eval_scope":"local","script_type":"sh","type":"","login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Fetch BP UUID","attrs":{"exit_status":[],"script":"#region define variables\njwt     = '@@{calm_jwt}@@'\napi_server = \"localhost\"\napi_server_port = \"9440\"\napi_server_endpoint = \"\/api\/nutanix\/v3\/blueprints\/list\"\nbp = \"@@{OCP_BP}@@\"\n\nlength = 100\nurl = \"https:\/\/{}:{}{}\".format(\n    api_server,\n    api_server_port,\n    api_server_endpoint\n)\n#endregion\n\n# region prepare api call\nmethod = \"POST\"\nheaders = {\n    'Content-Type': 'application\/json',\n    'Accept': 'application\/json',\n    'Authorization': 'Bearer {}'.format(jwt)\n}\n\n# Compose the json payload\npayload = {\n  \"kind\": \"blueprint\",\n  \"offset\": 0,\n  \"length\": length\n}\n# endregion\n\n#region make the api call\nprint(\"Making a {} API call to {}\".format(method, url))\nr = urlreq(\n    url,\n    verb=method,\n    params=json.dumps(payload),\n    headers=headers,\n    verify=False\n)\n#endregion\n\n#region process the results\nif r.ok:\n  for entity in json.loads(r.content)['entities']:\n    #print entity\n    if entity['status']['name'] == bp:\n      blueprint_uuid=entity['status']['uuid']\n      print 'blueprint_uuid='+blueprint_uuid\n# If the call failed\nelse:\n    # print the content of the response (which should have the error message)\n    print(\"Request failed\", json.dumps(\n        json.loads(r.content),\n        indent=4\n    ))\n    print(\"Headers: {}\".format(headers))\n    print(\"Payload: {}\".format(payload))\n    exit(1)\n# endregion\n","eval_variables":["blueprint_uuid"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"run Blueprint","attrs":{"exit_status":[],"script":" #region define variables\njwt     = '@@{calm_jwt}@@'\napi_server = \"localhost\"\napi_server_port = \"9440\"\napi_server_endpoint = \"\/api\/nutanix\/v3\/blueprints\/{}\/runtime_editables\".format(\"@@{blueprint_uuid}@@\")\n\nlength = 100\nurl = \"https:\/\/{}:{}{}\".format(\n    api_server,\n    api_server_port,\n    api_server_endpoint\n)\n#endregion\n\n# region prepare api call\nmethod = \"GET\"\nheaders = {\n    'Content-Type': 'application\/json',\n    'Accept': 'application\/json',\n    'Authorization': 'Bearer {}'.format(jwt)\n}\n\n\n#region make the api call\nprint(\"Making a {} API call to {}\".format(method, url))\nr = urlreq(\n    url,\n    verb=method,\n    headers=headers,\n    verify=False\n)\n#endregion\n\n#region process the results\nif r.ok:\n    resp_json = json.loads(r.content)\n    #variable_list = json.dumps(json_resp['resources'][0]['runtime_editables']['variable_list'])\n# If the call failed\nelse:\n    # print the content of the response (which should have the error message)\n    print(\"Request failed\")\n    exit(1)\n# endregion\n\n\n#### RUN BP\n\n#region define variables\napi_server_endpoint = \"\/api\/nutanix\/v3\/blueprints\/{}\/simple_launch\".format(\"@@{blueprint_uuid}@@\")\n\nlength = 100\nurl = \"https:\/\/{}:{}{}\".format(\n    api_server,\n    api_server_port,\n    api_server_endpoint\n)\n#endregion\n\n# region prepare api call\nmethod = \"POST\"\nheaders = {\n    'Content-Type': 'application\/json',\n    'Accept': 'application\/json',\n    'Authorization': 'Bearer {}'.format(jwt)\n}\n\n# Compose the json payload\npayload = {\n  \"spec\": {\n    \"app_name\": \"Openshift @@{OCP_SUBDOMAIN}@@-@@{BP_suffix}@@\",\n    \"app_description\": \"Automated OCP Tenant\",\n    \"app_profile_reference\": {\n      \"kind\": \"app_profile\",\n      \"name\": \"\"\n    },\n    \"runtime_editables\": {\n      \"variable_list\":[],\n      \"credential_list\":[]\n    }\n  }\n}\n\nif (@@{WORKER}@@==0):\n\tpayload['spec']['app_profile_reference']['name']='MasterOnly'\nelse:\n\tpayload['spec']['app_profile_reference']['name']='MasterWorker'\n\n\npayload['spec']['runtime_editables']['variable_list']=resp_json['resources'][0]['runtime_editables']['variable_list']\npayload['spec']['runtime_editables']['credential_list']=resp_json['resources'][0]['runtime_editables']['credential_list']\n\npayload['spec']['runtime_editables']['variable_list'][0]['value']['value']=\"@@{BASE_DOMAIN}@@\"\npayload['spec']['runtime_editables']['variable_list'][1]['value']['value']=\"@@{OCP_SUBDOMAIN}@@\"\npayload['spec']['runtime_editables']['variable_list'][2]['value']['value']=\"@@{address}@@\"\npayload['spec']['runtime_editables']['variable_list'][3]['value']['value']=\"@@{OCP_MACHINE_NETWORK}@@\"\npayload['spec']['runtime_editables']['variable_list'][4]['value']['value']='@@{KUBECONFIG}@@'\npayload['spec']['runtime_editables']['variable_list'][5]['value']['value']='@@{KUBEADMIN}@@'\npayload['spec']['runtime_editables']['variable_list'][6]['value']['value']='@@{platform.status.resources.nic_list[0].subnet_reference.uuid}@@'\npayload['spec']['runtime_editables']['variable_list'][7]['value']['value']='@@{WORKER}@@'\npayload['spec']['runtime_editables']['variable_list'][8]['value']['value']='@@{azPC_IP}@@'\n\n\npayload['spec']['runtime_editables']['credential_list'][0]['value']['secret']['attrs']['is_secret_modified']=True\n\nol_cred =\"\"\"@@{CRED.secret}@@\"\"\"\npayload['spec']['runtime_editables']['credential_list'][0]['value']['secret']['value']=ol_cred\n\nprint payload\n# endregion\n\n#region make the api call\nprint(\"Making a {} API call to {}\".format(method, url))\nr = urlreq(\n    url,\n    verb=method,\n    params=json.dumps(payload),\n    headers=headers,\n    verify=False\n)\n#endregion\n\n#region process the results\nif r.ok:\n    resp_json = json.loads(r.content)\n    print \"launch_uuid={}\".format(resp_json[\"status\"][\"request_id\"])\n# If the call failed\nelse:\n    # print the content of the response (which should have the error message)\n    print(\"Request failed\", json.dumps(\n        json.loads(r.content),\n        indent=4\n    ))\n    print(\"Headers: {}\".format(headers))\n    print(\"Payload: {}\".format(payload))\n    exit(1)\n# endregion","eval_variables":["launch_uuid"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Provisioning VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Monitor BP","attrs":{"script":" #region define variables\njwt     = '@@{calm_jwt}@@'\napi_server = \"localhost\"\napi_server_port = \"9440\"\napi_server_endpoint = \"\/api\/nutanix\/v3\/blueprints\/{}\/pending_launches\/{}\".format(\"@@{blueprint_uuid}@@\",\"@@{launch_uuid}@@\")\n\nlength = 100\nurl = \"https:\/\/{}:{}{}\".format(\n    api_server,\n    api_server_port,\n    api_server_endpoint\n)\n#endregion\n\n# region prepare api call\nmethod = \"GET\"\nheaders = {\n    'Content-Type': 'application\/json',\n    'Accept': 'application\/json',\n    'Authorization': 'Bearer {}'.format(jwt)\n}\n\n\n#region make the api call\nprint(\"Making a {} API call to {}\".format(method, url))\nr = urlreq(\n    url,\n    verb=method,\n    headers=headers,\n    verify=False\n)\n#endregion\n\n#region process the results\nif r.ok:\n    print r.content\n    #variable_list = json.dumps(json_resp['resources'][0]['runtime_editables']['variable_list'])\n# If the call failed\nelse:\n    # print the content of the response (which should have the error message)\n    print(\"Request failed\")\n    exit(1)\n# endregion\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"3cc54f0e_runbook","main_task_local_reference":{"kind":"app_task","name":"99ba075b_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"OCP_BP","value":"OCP-MasterWorker-dsta","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"OCP_CLUSTER_HOSTPREFIX","value":"23","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"OCP_CLUSTER_NETWORK","value":"10.128.0.0\/14","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"OCP_SERVICE_NETWORK","value":"172.30.0.0\/16","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"OCP_MACHINE_NETWORK","value":"10.55.76.0\/25","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"OCP_SUBDOMAIN","value":"ocp1","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"BASE_DOMAIN","value":"infra.dsta.local","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"OCP_PULL_SECRET","value":"{\"auths\":{\"ocp-mirror.infra.dsta.local:5000\":{\"auth\":\"bnV0YW5peDpudXRhbml4\",\"email\":\"ronald.pereira@nutanix.com\"}}}","label":"","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":true,"value":"^([1-4][0-9]|[0,2-9])$"},"val_type":"STRING","is_mandatory":false,"description":"Should be 0 or 2+, Stage2 Blueprint needs support for this","data_type":"BASE","type":"LOCAL","name":"WORKER","value":"2","label":"Number of Workers","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"azPC_IP","value":"172.16.101.53","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"BP_suffix","value":"52","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"name":"Deploy OCP"}],"name":"Nutanix","restore_config_list":[],"snapshot_config_list":[],"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"coreos_installer","value":"http:\/\/172.16.101.188\/images\/openshift\/coreos-installer_amd64","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"openshift_install_linux","value":"http:\/\/172.16.101.188\/images\/openshift\/openshift-install-linux.tar.gz","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"openshift_client_linux","value":"http:\/\/172.16.101.188\/images\/openshift\/openshift-client-linux.tar.gz","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"rhcos_live","value":"http:\/\/172.16.101.188\/images\/openshift\/rhcos-live.x86_64.iso","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CRED"},"type":"USER"},"name":"OCP-ProvVM-dsta"},"api_version":"3.0","metadata":{"last_update_time":"1639093494031356","kind":"blueprint","spec_version":11,"creation_time":"1639027201001029","name":"OCP-ProvVM-dsta"}}